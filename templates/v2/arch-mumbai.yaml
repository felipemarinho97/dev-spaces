template_name: archlinux
host_ami: ami-03f8af322da4ba57f # minimal amazon linux AMI
availability_zone: ap-south-1b
key_name: Mumbai
prefered_instance_type: t3a.nano
instance_profile_arn: arn:aws:iam::568126575653:instance-profile/EC2Config
storage_size: 8 # expressed in (GB)
host_storage_size: 8 # expressed in (GB), size must be compatible with host_ami
startup_script: |
  #!/bin/bash -xe
  exec > >(tee /var/log/user-data.log|logger -t user-data -s 2>/dev/console) 2>&1

  ## add ssd key to the chroot machine and export it to port 2222
  sed '/#Port 22/s/#Port 22/Port 2222/g' -i /etc/ssh/sshd_config
  systemctl restart sshd

  ## attach the volume
  mkdir -p ~/.aws
  printf "[profile default]\n output = json\n region = ap-south-1 " > ~/.aws/config
  DEVICE=/dev/nvme1n1p1
  IAD=$(curl http://169.254.169.254/latest/meta-data/instance-id)
  aws ec2 attach-volume --volume-id={{volume_id}} --device=$DEVICE --instance-id=$IAD

  ## wait for the volume to attach
  while [ ! -e $DEVICE ]; do
    sleep 1s
  done

  ## mount arch linux
  mkdir -p /arch 
  mount $DEVICE /arch

  ## boot the chroot machine
  systemd-nspawn --boot --quiet --machine=arch --system-call-filter='add_key keyctl bpf' -D /arch/

# Arch Linux EC2 optimized AMI (us-east-1), only used when creating the dev-space
# you can find the amis here: http://arch-ami-list.drzee.net/
# devspace_ami: ami-03f8af322da4ba57f # change this to your region ami
devspace_ami: ami-03f8af322da4ba57f # minimal amazon linux AMI